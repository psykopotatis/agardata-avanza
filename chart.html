<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>Loading... | aktiedata.org</title>
      <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BSZX8Y630Z"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BSZX8Y630Z');
    </script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f4f4f4;
        }

        #container {
            width: 100%;
            height: 100vh;
        }
    </style>
    <!-- ant design 4 includes global css classes -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@4.24.13/dist/antd.min.css" />
</head>
<body>
<!-- Stock selector -->
<div class="ant-card ant-card-bordered" style="
position: absolute;
top: 10px;
left: 90px;
width: 280px;
border-radius: 5px;
box-shadow: 0 0 5px #ccc;
z-index: 1000;
">
  <div class="ant-card-body">
    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Välj aktie:</label>
    <select id="stock-selector" class="ant-select" style="
      width: 100%;
      padding: 8px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    ">
      <option value="">Laddar...</option>
    </select>
  </div>
</div>

    <div id="container"></div>

    <script>
        let currentChart = null;
        let currentStock = 'ASCELIA';

        // Load available stocks and populate selector
        function loadStockSelector() {
            fetch('/api/stocks')
                .then(res => res.json())
                .then(data => {
                    const selector = document.getElementById('stock-selector');
                    selector.innerHTML = '';

                    data.stocks.forEach(stock => {
                        const option = document.createElement('option');
                        option.value = stock.key;
                        option.textContent = stock.name;
                        if (stock.key === data.default) {
                            option.selected = true;
                            currentStock = stock.key;
                        }
                        selector.appendChild(option);
                    });

                    // Add change event listener
                    selector.addEventListener('change', (e) => {
                        currentStock = e.target.value;
                        loadStockData(currentStock);
                    });

                    // Load initial stock data
                    loadStockData(currentStock);
                })
                .catch(err => {
                    console.error('Error loading stocks:', err);
                    document.getElementById('stock-selector').innerHTML = '<option>Fel vid laddning</option>';
                });
        }

        // Load data for a specific stock
        function loadStockData(stockKey) {
            // Update page title
            fetch(`/api/config?stock=${stockKey}`)
                .then(res => res.json())
                .then(config => {
                    const stockName = config.stockName;
                    document.title = `${stockName} - antal ägare på Avanza | aktiedata.org`;
                    window.stockName = stockName;
                })
                .catch(err => {
                    console.error('Error fetching config:', err);
                });

            // Update chart
            loadChartData(stockKey);
        }

        function loadChartData(stockKey) {
            // Show loading state
            document.getElementById('container').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh;">Laddar diagram...</div>';

            Promise.all([
                fetch(`data.json?stock=${stockKey}`).then(res => {
                    if (!res.ok) throw new Error(`Kunde inte hämta historisk data (HTTP ${res.status})`);
                    return res.json();
                }),
                fetch(`/api/market-guide?stock=${stockKey}`).then(res => {
                    if (!res.ok) throw new Error(`Kunde inte hämta aktuell marknadsdata (HTTP ${res.status})`);
                    return res.json();
                })
            ])
            .then(([dataJson, marketGuide]) => {
                // Get original data
                const seriesData = dataJson.ownersPoints.map(point => [point.timestamp, point.numberOfOwners]);

                // Get today's timestamp
                const today = new Date();
                const todayTimestamp = today.getTime();

                // Get current number of owners from marketGuide
                const currentOwners = marketGuide.keyIndicators.numberOfOwners;

                // Add it to the series
                seriesData.push([todayTimestamp, currentOwners]);

                // Sort data by timestamp
                seriesData.sort((a, b) => a[0] - b[0]);

                // Destroy previous chart if it exists
                if (currentChart) {
                    currentChart.destroy();
                }

                // Clear container
                document.getElementById('container').innerHTML = '';

                // Create the Highcharts chart
                currentChart = Highcharts.chart('container', {
                    chart: {
                        type: 'line',
                        zoomType: 'x', // Enables zooming on x-axis (time)
                        height: window.innerHeight,
                        resetZoomButton: {
                            position: {
                                align: 'right',
                                verticalAlign: 'top',
                                x: -10,
                                y: 10
                            }
                        }
                    },
                    title: {
                        text: `${window.stockName || 'Loading...'} - antal ägare på Avanza`
                    },
                    xAxis: {
                        type: 'datetime',
                        title: {
                            text: 'Date'
                        },
                        ordinal: false,  // Ensures proper zooming behavior
                        minRange: 7 * 24 * 3600 * 1000  // Prevents zooming in too much (7 days min range)
                    },
                    yAxis: {
                        title: {
                            text: 'Number of Owners'
                        }
                    },
                    tooltip: {
                        shared: true,
                        crosshairs: true
                    },
                    legend: {
                        enabled: false
                    },
                    series: [{
                        name: 'Owners',
                        data: seriesData
                    }],
                    credits: {
                        enabled: false
                    }
                });

            }).catch(error => {
                console.error('Error loading chart data:', error);
                document.getElementById('container').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; color: #ff4d4f;">
                        <h2>Fel vid laddning av diagram</h2>
                        <p>${error.message || 'Okänt fel uppstod'}</p>
                        <p style="font-size: 14px; color: #666;">Försök ladda om sidan eller kontrollera din internetanslutning.</p>
                    </div>
                `;
            });
        }

        // Adjust chart size on window resize
        window.addEventListener('resize', () => {
            if (currentChart) {
                currentChart.setSize(null, window.innerHeight, false);
            }
        });

        // Initialize the page
        loadStockSelector();

    </script>
</body>
</html>
