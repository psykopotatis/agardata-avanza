<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>Ascelia Owners Chart</title>
      <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BSZX8Y630Z"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BSZX8Y630Z');
    </script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f4f4f4;
        }

        #container {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
<div id="info-box" style="position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 5px #ccc;">
  <strong>Ascelia Pharma – Ägare:</strong>
  <div id="owner-info">Laddar...</div>
</div>

    <div id="container"></div>

    <script>
        fetch('/api/ascelia-owner-change')
  .then(res => res.json())
  .then(info => {
    document.getElementById('owner-info').innerHTML = `
      <div><strong>Nuvarande ägare:</strong> ${info.numberOfOwners.toLocaleString()}</div>
      <div><strong>Förändring:</strong></div>
      <ul>
        <li>1 dag: ${info.changes["1d"]}</li>
        <li>1 vecka: ${info.changes["1w"]}</li>
        <li>1 månad: ${info.changes["1m"]}</li>
        <li>3 månader: ${info.changes["3m"]}</li>
        <li>i år: ${info.changes["ytd"]}</li>
      </ul>
    `;
  })
  .catch(err => {
    document.getElementById('owner-info').textContent = 'Fel vid hämtning.';
    console.error(err);
  });

        // Fetch data.json dynamically
    Promise.all([
        fetch('data.json').then(res => res.json()),
        fetch('/api/market-guide').then(res => res.json())
    ])
    .then(([dataJson, marketGuide]) => {
        // Get original data
        const seriesData = dataJson.ownersPoints.map(point => [point.timestamp, point.numberOfOwners]);

        // Get today's timestamp
        const today = new Date();
        const todayTimestamp = today.getTime();

        // Get current number of owners from marketGuide
        const currentOwners = marketGuide.keyIndicators.numberOfOwners;

        // Add it to the series
        seriesData.push([todayTimestamp, currentOwners]);

        // Sort data by timestamp
        seriesData.sort((a, b) => a[0] - b[0]);

        // Create the Highcharts chart
        Highcharts.chart('container', {
            chart: {
                type: 'line',
                zoomType: 'x', // Enables zooming on x-axis (time)
                height: window.innerHeight,
                resetZoomButton: {
                    position: {
                        align: 'right',
                        verticalAlign: 'top',
                        x: -10,
                        y: 10
                    }
                }
            },
            title: {
                text: 'Ascelia Owners Over Time'
            },
            xAxis: {
                type: 'datetime',
                title: {
                    text: 'Date'
                },
                ordinal: false,  // Ensures proper zooming behavior
                minRange: 7 * 24 * 3600 * 1000  // Prevents zooming in too much (7 days min range)
            },
            yAxis: {
                title: {
                    text: 'Number of Owners'
                }
            },
            tooltip: {
                shared: true,
                crosshairs: true
            },
            legend: {
                enabled: false
            },
            series: [{
                name: 'Owners',
                data: seriesData
            }],
            credits: {
                enabled: false
            }
        });

        // Adjust chart size on window resize
        window.addEventListener('resize', () => {
            Highcharts.charts[0].setSize(null, window.innerHeight, false);
        });

    }).catch(error => console.error('Error loading JSON:', error));

    </script>
</body>
</html>
